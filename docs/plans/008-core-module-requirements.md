# ADR-008: core/ モジュール要件（統合テスト編）

## ステータス

提案中

## 目的

`core/` モジュールが満たすべき要件を、**統合テスト（integration）観点で具体化**する。特に `APScheduler`、`BlogWatcher`、永続化（SQLite）、シャットダウン制御の相互作用を検証対象とする。ヘルスエンドポイントは「必要性の検討」を行った上で扱う。

## 前提・スコープ

- 対象: `core/` とその周辺（`storage/`, `detection/`, `notifications/`）の結合点
- 依存: ADR-006（アーキテクチャ）、ADR-007（テスト戦略）、ADR-005（エラーハンドリング）
- 非対象: ユニットテストで完結する純粋ロジックや詳細な通知フォーマット

## 統合テスト要件

### 必須シナリオ（ADR-007に準拠）

#### IT-CORE-001: スケジューラが設定間隔でジョブを実行する
- **目的**: `WatcherScheduler` が定期ジョブを正しく登録・実行する
- **前提**: `interval_seconds=1` の設定、ブログは1件
- **手順**:
  1. Schedulerをstart
  2. 2.5秒待機
  3. 実行回数を確認
- **期待結果**: 2回以上のジョブ実行を確認
- **補足**: `@pytest.mark.slow`

#### IT-CORE-002: シャットダウン時に実行中ジョブが完了する
- **目的**: グレースフルシャットダウンを保証する
- **前提**: ジョブ実行時間 > shutdown猶予時間
- **手順**:
  1. ジョブ開始（長時間処理を模擬）
  2. シャットダウン要求（SIGTERM相当）
  3. 完了まで待機
- **期待結果**: 実行中ジョブは完了し、後続ジョブは起動しない

#### IT-CORE-003: 実DBでのチェックサイクルが状態を永続化する
- **目的**: `core` → `detection` → `storage` が結合したデータフローを確認
- **前提**: tmp_pathのSQLite、ブログ1件
- **手順**:
  1. 初回チェック実行
  2. 状態テーブル（blog_state）を確認
  3. 2回目チェックを実行
  4. 履歴テーブル（check_history）を確認
- **期待結果**:
  - 初回で state が作成される
  - 2回目で履歴が追加される

#### IT-CORE-004: （削除）/health は採用しない
- **理由**: 本プロジェクトでは監視対象をアプリ外（プロセス監視・ログ監視）で担保する

### 追加推奨シナリオ（品質を上げる補助）

#### IT-CORE-005: 一部ブログ失敗時でも全体処理を継続する
- **目的**: 部分失敗耐性（ADR-005）を統合テストで検証
- **期待結果**: 失敗ブログは記録され、他ブログの検知は継続

#### IT-CORE-006: max_instances超過時にジョブが重複しない
- **目的**: APSchedulerのジョブ重複抑止
- **期待結果**: 同一ジョブが並行実行されない

#### IT-CORE-007: （削除）/health 連動の異常経路

## 共通テスト設計

### テストダブル戦略

- **HTTP取得**: pytest-httpserver（外部ネットワークを禁止）
- **DB**: tmp_path で実SQLite
- **Notifier**: ダミー実装（送信回数のみ検証）
- **Scheduler**: 実 `AsyncIOScheduler` を使用（mockはユニット向け）

### 計測と検証点

- **実行回数**: ジョブ実行カウンタ
- **永続化**: blog_state / check_history の行数
- **ログ**: 重要なエラーが記録されること（structlog捕捉）
- **レイテンシ**: テスト合計 <30s の範囲

### テスト配置（予定）

```
tests/integration/core/
  test_scheduler.py
  test_shutdown.py
  test_end_to_end.py
```

## 合否基準

- 必須シナリオ 3件がすべて成功すること
- DBへの書き込みが確認できること
- シャットダウン時に未完了ジョブが残らないこと
