# ADR-009: ロギング戦略

## ステータス

提案中

## コンテキスト

現状のコードベースにはロギング実装が存在しないが、ADR-001では `structlog` を採用している。実装に先立ち、ログの置き場所、レベル、フォーマット、サニタイズ方針を明確にする必要がある。

## 決定

### 1. 配置

- `src/blog_watcher/observability/` を新設し、ログ関連はここに集約する。
- 初期化・共通処理は `observability/logging.py` に置く。
- 各モジュールは `get_logger(name)` でロガーを取得し、個別に初期化しない。

### 2. ログレベル

- `LOG_LEVEL` 環境変数で制御（デフォルト **INFO**）。
- 使い分け指針:
  - `DEBUG`: リクエスト/レスポンス詳細、リトライ回数、計測情報。
  - `INFO`: 通常動作（スケジューラ実行、変更検知、通知成功）。
  - `WARNING`: 一時的な失敗やリトライ発生、部分的失敗。
  - `ERROR`: 恒久的失敗、リトライ枯渇、DB/Slackの致命的エラー。

### 3. フォーマット

- デフォルト: **JSON**。
- ローカル開発向けに `LOG_FORMAT=console` を許可。

### 4. サニタイズと安全性

主目的は**機密漏洩防止**。加えてログ注入を避けるための最小限の無害化を行う。

- キー名によるマスク（大小無視）:
  - `token`, `api_key`, `authorization`, `cookie`, `webhook`, `secret`, `password`
- URL内の秘密情報（例: `token=...`）はマスク。
- Slack Webhook URL はフルパスをマスク。
- 制御文字（`\n`, `\r`, `\t`）は空白に置換。
- 長すぎる文字列は上限（例: 4000文字）で切り詰め。

### 5. どこでログを出すか

- `core/`:
  - 監視サイクル開始/終了。
  - 変更検知の結果。
- `detection/`:
  - 取得結果（ステータス/変更有無）、リトライ開始/失敗。
- `notification/`:
  - Slack送信成功/失敗。
- `storage/`:
  - 重大なDBエラーのみ（通常クエリはログしない）。

## 結果

- ログ基準が統一され、運用時の解析が容易になる。
- 機密情報がログに残らない。
- 環境変数で粒度と可読性を調整できる。

## 未決事項

- 相関IDの導入（将来対応）。
